<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>DPR ‚Äî Kiosk (DEMO z PrewencjƒÖ i QR)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --primary-color: #0284c7;
        --primary-dark: #0369a1;
        --accent: #f59e0b;
        --success: #10b981;
        --danger: #ef4444;
        --bg: #f8fafc;
        --panel: #fff;
        --text: #0f172a;
        --muted: #64748b;
        --border: #e5e7eb;
        --purple: #a855f7;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      /* Header (jak w kiosku) */
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-dark)
        );
        color: #fff;
        padding: 16px 20px;
        box-shadow: 0 6px 16px rgba(2, 132, 199, 0.35);
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .header h1 {
        margin: 0;
        font-size: 18px;
        font-weight: 900;
        letter-spacing: 0.2px;
      }
      .toolbar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .btn {
        padding: 10px 14px;
        border: none;
        border-radius: 10px;
        font-weight: 800;
        color: #fff;
        background: var(--primary-color);
        cursor: pointer;
        box-shadow: 0 6px 18px rgba(2, 132, 199, 0.35);
        transition: all 0.15s ease;
      }
      .btn:hover {
        filter: brightness(1.05);
        transform: translateY(-1px);
      }
      .btn.secondary {
        background: #6b7280;
      }
      .btn.accent {
        background: var(--accent);
        color: #111;
      }
      .btn.success {
        background: var(--success);
      }
      .btn.danger {
        background: var(--danger);
      }
      .btn.purple {
        background: var(--purple);
      }
      .wrap {
        max-width: 1100px;
        margin: 16px auto;
        padding: 0 16px 24px;
      }

      /* Karty (jak kiosk-card) */
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        margin: 12px 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
      }
      .title {
        font-size: 18px;
        font-weight: 900;
        color: #0b3b5a;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--border);
        padding-bottom: 8px;
        margin-bottom: 12px;
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      .id-pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        background: #e2e8f0;
        color: #0f172a;
        font-weight: 800;
        font-size: 12px;
      }
      .status-dot {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        border: 1px solid var(--border);
        display: inline-block;
      }

      .progress {
        height: 10px;
        background: #e5e7eb;
        border-radius: 999px;
        overflow: hidden;
      }
      .progress > div {
        height: 100%;
        background: var(--primary-color);
        border-radius: 999px;
        width: 0%;
        transition: width 0.2s;
      }
      .progress-label {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }
      .item-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid var(--border);
      }
      .item-row:last-child {
        border-bottom: none;
      }

      /* Login QR */
      #viewLogin .hero {
        max-width: 860px;
        margin: 24px auto;
        display: grid;
        gap: 18px;
        justify-items: center;
        text-align: center;
      }
      .qr-tile {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 520px;
        padding: 28px;
        border: 2px dashed #cbd5e1;
        border-radius: 16px;
        background: #f0f9ff;
      }
      .qr-btn {
        font-size: 22px;
        padding: 16px 22px;
        border-radius: 12px;
        background: #0ea5e9;
        color: #fff;
        border: none;
        cursor: pointer;
        box-shadow: 0 6px 18px rgba(14, 165, 233, 0.35);
        font-weight: 900;
      }
      .qr-btn:hover {
        filter: brightness(1.05);
        transform: translateY(-1px);
      }

      /* Prewencja ‚Äì kioskowe segmenty */
      .tasks {
        display: grid;
        gap: 12px;
        margin: 8px 0;
      }
      .task {
        display: grid;
        gap: 8px;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #fff;
      }
      .task h4 {
        margin: 0;
        font-size: 16px;
        color: #0b3b5a;
      }
      .seg {
        display: inline-flex;
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
      }
      .seg .opt {
        padding: 10px 14px;
        background: #e5e7eb;
        color: #111;
        border: none;
        font-weight: 900;
        cursor: pointer;
        min-width: 78px;
      }
      .seg .opt:hover {
        filter: brightness(1.02);
      }
      .seg .opt.active.yes {
        background: var(--success);
        color: #fff;
      }
      .seg .opt.active.no {
        background: var(--danger);
        color: #fff;
      }

      /* Kiosk ‚Äì przyciski akcji jak w oryginale */
      .k-actions {
        display: grid;
        grid-template-columns: repeat(5, minmax(110px, 1fr));
        gap: 12px;
        width: 100%;
        max-width: 820px;
        margin: 0 auto;
      }
      .k-actions .kbtn {
        height: 72px;
        border-radius: 12px;
        font-weight: 900;
        font-size: 18px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        color: #fff;
        transition: transform 0.15s ease, filter 0.15s ease,
          box-shadow 0.15s ease, border-color 0.15s ease;
        background: var(--primary-color);
        border: 3px solid transparent;
        cursor: pointer;
      }
      .k-actions .kbtn.start {
        background: var(--success);
      }
      .k-actions .kbtn.pause {
        background: var(--accent);
        color: #111;
      }
      .k-actions .kbtn.failure {
        background: var(--danger);
      }
      .k-actions .kbtn.change {
        background: var(--purple);
      }
      .k-actions .kbtn.end {
        background: #64748b;
      }
      .k-actions .kbtn.k-active {
        box-shadow: 0 0 0 5px rgba(2, 132, 199, 0.28),
          0 16px 30px rgba(0, 0, 0, 0.18);
        filter: brightness(1.18) saturate(1.12);
        transform: translateY(-3px);
        border-color: #0ea5e9;
      }
      .k-topstate {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: #eef2ff;
        border: 1px solid #c7d2fe;
        color: #3730a3;
        font-size: 12px;
        font-weight: 800;
      }

      /* Modale */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        align-items: center;
        justify-content: center;
        z-index: 99;
      }
      .box {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        width: 900px;
        max-width: 95vw;
        padding: 16px;
      }
      .box h3 {
        margin-top: 0;
        color: var(--primary-color);
      }
      .close {
        float: right;
        cursor: pointer;
        font-weight: 900;
        color: var(--primary-color);
      }
      /* Aparat/QR ‚Äì idealnie wy≈õrodkowany */
      .cam {
        position: relative;
        border-radius: 12px;
        border: 2px dashed #94a3b8;
        height: 320px;
        display: grid;
        place-items: center;
        background: #0b1220;
        background-image: linear-gradient(
            transparent 24px,
            rgba(255, 255, 255, 0.06) 25px
          ),
          linear-gradient(
            90deg,
            transparent 24px,
            rgba(255, 255, 255, 0.06) 25px
          );
        background-size: 25px 25px;
        background-position: center center;
        color: #e2e8f0;
      }
      .cam .overlay {
        position: absolute;
        inset: 12px;
        border: 2px solid rgba(255, 255, 255, 0.25);
        border-radius: 8px;
        pointer-events: none;
      }
      .qr-sample {
        width: 160px;
        height: 160px;
        border-radius: 8px;
        background: #fff;
        display: grid;
        place-items: center;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
      }
      .cam-hint {
        font-size: 12px;
        color: #93c5fd;
        margin-top: 6px;
        text-align: center;
      }

      /* Toast */
      .toast {
        position: fixed;
        right: 16px;
        bottom: 16px;
        background: #111827;
        color: #fff;
        padding: 10px 14px;
        border-radius: 10px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        z-index: 999;
        display: none;
        /* Wy≈õrodkuj pasek postƒôpu */
        #kProgressBox {
          width: 100%;
          max-width: 820px;
          margin: 12px auto 0;
        }
      }
      /* ==== NOWE STYLE CENTRUJƒÑCE (FINALNA WERSJA) ==== */
      .current-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center; /* TO JEST KLUCZ: centruje wszystko w poziomie */
        gap: 16px; /* Odstƒôp miƒôdzy blokami: info, przyciski, pasek */
      }
      .current-info-block {
        text-align: center; /* Centruje tekst, je≈õli siƒô zawinie */
      }
      .k-actions {
        margin-top: 10px; /* Drobny margines nad przyciskami */
      }
      #kProgressBox {
        width: 100%;
        max-width: 820px; /* Taka sama szeroko≈õƒá jak przyciski */
        text-align: center;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <h1>DPR ‚Äî Kiosk (DEMO z PrewencjƒÖ i QR)</h1>
      <div class="toolbar">
        <button class="btn secondary" id="btnLogout" style="display: none">
          Wyloguj
        </button>
        <button class="btn secondary" id="btnReset" style="display: none">
          Reset demo
        </button>
        <button class="btn accent" id="btnSOS" style="display: none">
          üÜò SOS
        </button>
      </div>
    </header>

    <!-- LOGOWANIE -->
    <div id="viewLogin" class="wrap">
      <div class="hero">
        <div style="font-size: 22px; font-weight: 900; color: #0b3b5a">
          Zaloguj siƒô przez QR, aby uruchomiƒá Kiosk
        </div>
        <div class="qr-tile">
          <div style="font-size: 14px; color: #0b3b5a">
            Skanowanie QR (tryb demo)
          </div>
          <button class="qr-btn" id="btnLoginQR">Zaloguj przez QR</button>
          <div class="muted">Symulacja aparatu + przyk≈Çadowy QR</div>
        </div>
        <div class="muted">Lub</div>
        <button class="btn" id="btnSkip">
          Uruchom kiosk bez logowania (demo)
        </button>
      </div>
    </div>

    <!-- PREWENCJA -->
    <div id="viewPrev" class="wrap" style="display: none">
      <div class="card">
        <div class="title">
          <span>Raport prewencji</span>
          <span class="k-topstate">Przed uruchomieniem linii</span>
        </div>
        <div class="muted">
          Wykonaj wszystkie kroki kontrolne przed rozpoczƒôciem pracy. Je≈õli
          kt√≥rekolwiek kryterium nie przejdzie ‚Äî automatycznie zg≈Çosimy awariƒô.
        </div>
        <div class="tasks" style="margin-top: 10px">
          <div class="task" data-key="onSite">
            <h4>1) Sprawd≈∫, czy silnik jest na miejscu</h4>
            <div class="seg">
              <button class="opt no">Nie</button>
              <button class="opt yes">Tak</button>
            </div>
            <div class="muted">
              Wybierz ‚ÄúTak‚Äù, je≈ºeli komponent znajduje siƒô w strefie roboczej.
            </div>
          </div>

          <div class="task" data-key="started">
            <h4>2) Sprawd≈∫, czy silnik siƒô uruchomi≈Ç</h4>
            <div class="seg">
              <button class="opt no">Nie</button>
              <button class="opt yes">Tak</button>
            </div>
            <div class="muted">
              Wybierz ‚ÄúTak‚Äù, je≈ºeli rozruch przebieg≈Ç prawid≈Çowo.
            </div>
          </div>

          <div class="task" data-key="noVib">
            <h4>3) Sprawd≈∫, czy nie ma nadmiernych wibracji</h4>
            <div class="seg">
              <button class="opt no">Nie</button>
              <button class="opt yes">Tak</button>
            </div>
            <div class="muted">Wybierz ‚ÄúTak‚Äù, je≈ºeli praca jest stabilna.</div>
          </div>
        </div>

        <div class="row" style="justify-content: flex-end; margin-top: 12px">
          <button class="btn success" id="btnPrevConfirm" disabled>
            Potwierd≈∫ prewencjƒô
          </button>
        </div>
      </div>
    </div>

    <!-- KIOSK -->
    <div id="viewKiosk" class="wrap" style="display: none">
      <div class="card">
        <div class="title">
          <span>Obecny materia≈Ç</span>
          <span class="k-topstate" id="topState">Proces: Oczekuje</span>
        </div>
        <div class="row" style="justify-content: space-between">
          <div id="currentInfo">Brak aktywnego materia≈Çu.</div>
          <div class="k-actions">
            <button class="kbtn start" id="kBtnStart">
              <span style="font-size: 22px">‚ñ∂Ô∏è</span>Start
            </button>
            <button class="kbtn pause" id="kBtnPause">
              <span style="font-size: 22px">‚è∏Ô∏è</span>Pauza
            </button>
            <button class="kbtn failure" id="kBtnFailure">
              <span style="font-size: 22px">‚õî</span>Awaria
            </button>
            <button class="kbtn change" id="kBtnChange">
              <span style="font-size: 22px">üü£</span>Zmiana
            </button>
            <button class="kbtn end" id="kBtnEnd">
              <span style="font-size: 22px">‚èπÔ∏è</span>Koniec
            </button>
          </div>
        </div>
        <div id="kProgressBox" style="margin-top: 10px"></div>
      </div>

      <div class="card">
        <div class="title">Nastƒôpny w kolejce</div>
        <div id="nextInfo" class="muted">Brak nastƒôpnego materia≈Çu.</div>
        <div class="row" style="justify-content: flex-end; margin-top: 8px">
          <button class="btn" id="btnStartNext">
            Rozpocznij kolejnego klienta
          </button>
        </div>
      </div>

      <div class="card">
        <div class="title">Lista materia≈Ç√≥w na linii</div>
        <div id="kioskList"></div>
      </div>

      <div class="card">
        <div class="title">Zako≈Ñczone materia≈Çy</div>
        <div id="kioskDoneList" class="muted">Brak zako≈Ñczonych.</div>
      </div>
    </div>

    <!-- MODAL: Aparat (QR) -->
    <div class="modal" id="qrModal">
      <div class="box">
        <span class="close" onclick="closeQR()">√ó</span>
        <h3 id="qrTitle">Zaloguj przez QR</h3>
        <div class="cam" id="camArea" title="Kliknij, aby zeskanowaƒá">
          <div class="overlay"></div>
          <div class="qr-sample" id="qrSample" aria-hidden="true">
            <!-- Pseudo-QR piƒôknie wy≈õrodkowany -->
            <svg viewBox="0 0 100 100" width="120" height="120">
              <rect x="0" y="0" width="100" height="100" fill="#000" />
              <rect x="8" y="8" width="26" height="26" fill="#fff" />
              <rect x="66" y="8" width="26" height="26" fill="#fff" />
              <rect x="8" y="66" width="26" height="26" fill="#fff" />
              <rect x="15" y="15" width="12" height="12" fill="#000" />
              <rect x="73" y="15" width="12" height="12" fill="#000" />
              <rect x="15" y="73" width="12" height="12" fill="#000" />
              <rect x="40" y="40" width="20" height="20" fill="#fff" />
              <rect x="45" y="45" width="10" height="10" fill="#000" />
            </svg>
          </div>
        </div>
        <div class="cam-hint" id="qrSubHint">
          Wersja demo: kliknij skaner, aby zasymulowaƒá skanowanie
        </div>
        <div
          class="row center"
          style="margin-top: 10px; justify-content: center"
        >
          <button class="btn" id="btnScan">Skanuj</button>
        </div>
      </div>
    </div>

    <!-- MODAL: Szczeg√≥≈Çy -->
    <div class="modal" id="detailsModal">
      <div class="box">
        <span class="close" onclick="closeDetails()">√ó</span>
        <h3>Szczeg√≥≈Çy przerobu</h3>
        <div id="detailsContent" class="muted">‚Äî</div>
      </div>
    </div>

    <!-- MODAL: Zdjƒôcia -->
    <div class="modal" id="photosModal">
      <div class="box">
        <span class="close" onclick="closePhotos()">√ó</span>
        <h3>PodglƒÖd zdjƒôƒá</h3>
        <div class="row" style="gap: 12px">
          <div style="flex: 1; min-width: 260px">
            <div class="muted" style="margin-bottom: 6px">Przed przerobem</div>
            <div
              style="
                border: 1px dashed var(--border);
                border-radius: 8px;
                height: 260px;
                display: grid;
                place-items: center;
              "
            >
              <em class="muted">Brak zdjƒôcia</em>
            </div>
          </div>
          <div style="flex: 1; min-width: 260px">
            <div class="muted" style="margin-bottom: 6px">Po przerobie</div>
            <div
              style="
                border: 1px dashed var(--border);
                border-radius: 8px;
                height: 260px;
                display: grid;
                place-items: center;
              "
            >
              <em class="muted">Brak zdjƒôcia</em>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: SOS -->
    <div class="modal" id="sosModal">
      <div class="box">
        <span class="close" onclick="closeSOS()">√ó</span>
        <h3>SOS / Kontakt</h3>
        <div
          class="row center"
          style="gap: 12px; margin: 12px 0; justify-content: center"
        >
          <button class="btn accent" onclick="sendHelp()">
            üÜò Potrzebujƒô pomocy
          </button>
          <button class="btn danger" onclick="openFailureQR()">
            üö® Zg≈Ço≈õ awariƒô (QR)
          </button>
        </div>
        <div class="muted">Wersja demo: zg≈Çoszenia sƒÖ tylko lokalne.</div>
      </div>
    </div>

    <!-- MODAL: Automatyczna awaria (po ‚ÄúNie‚Äù w prewencji) -->
    <div class="modal" id="autoFailModal">
      <div class="box">
        <span class="close" onclick="closeAutoFail()">√ó</span>
        <h3>Awaria zg≈Çoszona</h3>
        <div class="muted" style="margin: 10px 0 12px">
          Awaria zosta≈Ça zg≈Çoszona automatycznie, poczekaj na mechanik√≥w i nie
          uruchamiaj procesu!
        </div>
        <div class="row" style="justify-content: flex-end">
          <button class="btn" onclick="closeAutoFail()">OK</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      let loggedIn = false;
      let qrMode = "login"; // 'login' | 'failure'
      let prevState = { onSite: null, started: null, noVib: null };

      const demo = {
        line: "Turbo 1",
        throughput: 300,
        items: [
          {
            id: 1,
            material: "Silniki aluminiowe",
            amount: 5000,
            process: "Mielenie",
            percent: 60,
            comment: "Pilne zlecenie ZAM/2025/0012",
            timing: {},
          },
          {
            id: 2,
            material: "Silniki ≈ºeliwne",
            amount: 4200,
            process: "Sortowanie",
            percent: 55,
            comment: "",
            timing: {},
          },
          {
            id: 3,
            material: "Skrzynie bieg√≥w",
            amount: 3100,
            process: "Demonta≈º",
            percent: 65,
            comment: "",
            timing: {},
          },
        ],
        done: [],
      };

      const $ = (s) => document.querySelector(s);
      function toast(msg) {
        const t = $("#toast");
        t.textContent = msg;
        t.style.display = "block";
        setTimeout(() => {
          t.style.display = "none";
        }, 1600);
      }
      function idPill(id) {
        return `<span class="id-pill">${id}</span>`;
      }
      function statusDot(state) {
        const c =
          state === "working"
            ? "#22c55e"
            : state === "paused"
            ? "#f59e0b"
            : state === "failure"
            ? "#ef4444"
            : state === "change"
            ? "#a855f7"
            : state === "ended"
            ? "#000"
            : "#94a3b8";
        return `<span class="status-dot" style="background:${c}"></span>`;
      }
      function plannedReal(it) {
        return +(it.amount * ((it.percent || 0) / 100)).toFixed(1);
      }
      function ensureTiming(it) {
        it.timing = it.timing || {
          start: null,
          end: null,
          pauses: [],
          failures: [],
          changes: [],
          state: "idle",
        };
        ["pauses", "failures", "changes"].forEach(
          (k) =>
            (it.timing[k] = Array.isArray(it.timing[k]) ? it.timing[k] : [])
        );
        return it.timing;
      }
      function sumIntervals(arr) {
        let tot = 0;
        const now = Date.now();
        (arr || []).forEach((iv) => {
          const s = iv.start || 0;
          const e = (iv.end != null ? iv.end : now) || now;
          tot += Math.max(0, e - s);
        });
        return tot;
      }
      function computeProgress(it) {
        const t = it.timing || {};
        if (!t.start)
          return {
            processed: 0,
            total: plannedReal(it) || 0,
            pct: 0,
            state: t.state || "idle",
          };
        const end = t.end || Date.now();
        let work =
          end -
          t.start -
          sumIntervals(t.pauses) -
          sumIntervals(t.failures) -
          sumIntervals(t.changes);
        if (work < 0) work = 0;
        const processed = demo.throughput * (work / 3600000);
        const total = plannedReal(it) || 0;
        const pct =
          total > 0
            ? Math.max(0, Math.min(100, Math.round((processed / total) * 100)))
            : 0;
        return {
          processed,
          total,
          pct,
          state: t.state || (t.end ? "ended" : "working"),
        };
      }

      // WIDOKI
      function showLogin() {
        $("#viewLogin").style.display = "block";
        $("#viewPrev").style.display = "none";
        $("#viewKiosk").style.display = "none";
        $("#btnLogout").style.display = "none";
        $("#btnReset").style.display = "none";
        $("#btnSOS").style.display = "none";
      }
      function showPrev() {
        $("#viewLogin").style.display = "none";
        $("#viewPrev").style.display = "block";
        $("#viewKiosk").style.display = "none";
        $("#btnLogout").style.display = "inline-block";
        $("#btnReset").style.display = "none";
        $("#btnSOS").style.display = "none";
        bindPrevention();
      }
      function showKiosk() {
        $("#viewLogin").style.display = "none";
        $("#viewPrev").style.display = "none";
        $("#viewKiosk").style.display = "block";
        $("#btnLogout").style.display = "inline-block";
        $("#btnReset").style.display = "inline-block";
        $("#btnSOS").style.display = "inline-block";
        render();
      }

      // PREWENCJA
      function bindPrevention() {
        prevState = { onSite: null, started: null, noVib: null };
        const tasks = document.querySelectorAll(".task");
        tasks.forEach((task) => {
          const key = task.getAttribute("data-key");
          const yes = task.querySelector(".opt.yes");
          const no = task.querySelector(".opt.no");
          yes.onclick = () => {
            setTask(key, true, yes, no);
          };
          no.onclick = () => {
            setTask(key, false, yes, no);
            showAutoFail();
          };
          [yes, no].forEach((b) => b.classList.remove("active", "yes", "no"));
        });
        updatePrevButton();
      }
      function setTask(key, val, yesBtn, noBtn) {
        prevState[key] = val;
        if (val) {
          yesBtn.classList.add("active", "yes");
          noBtn.classList.remove("active", "no");
        } else {
          noBtn.classList.add("active", "no");
          yesBtn.classList.remove("active", "yes");
        }
        updatePrevButton();
      }
      function updatePrevButton() {
        const allYes =
          prevState.onSite === true &&
          prevState.started === true &&
          prevState.noVib === true;
        $("#btnPrevConfirm").disabled = !allYes;
      }
      function showAutoFail() {
        $("#autoFailModal").style.display = "flex";
      }
      function closeAutoFail() {
        $("#autoFailModal").style.display = "none";
        toast("Awaria zg≈Çoszona automatycznie.");
        setTimeout(() => showKiosk(), 250);
      }

      // KIOSK
      function render() {
        renderCurrent();
        renderNext();
        renderList();
        renderDone();
      }
      function getCurrentIndex() {
        const arr = demo.items;
        for (let i = 0; i < arr.length; i++) {
          const t = arr[i].timing || {};
          if (t.start && !t.end) return i;
        }
        for (let i = 0; i < arr.length; i++) {
          const t = arr[i].timing || {};
          if (!t.end) return i;
        }
        return -1;
      }
      function getNextIndex(cur) {
        const arr = demo.items;
        for (let i = cur + 1; i < arr.length; i++) {
          const t = arr[i].timing || {};
          if (!t.end) return i;
        }
        return -1;
      }
      function setButtonsState(it) {
        const S = {
          start: $("#kBtnStart"),
          pause: $("#kBtnPause"),
          failure: $("#kBtnFailure"),
          change: $("#kBtnChange"),
          end: $("#kBtnEnd"),
        };
        Object.values(S).forEach((b) => (b.disabled = false));
        document
          .querySelectorAll(".k-actions .kbtn")
          .forEach((b) => b.classList.remove("k-active"));
        if (!it) return;
        const t = ensureTiming(it);
        const ended = !!t.end;
        S.start.disabled = ended;
        S.pause.disabled = !t.start || ended;
        S.failure.disabled = !t.start || ended;
        S.change.disabled = !t.start || ended;
        S.end.disabled = !t.start || ended;
        if (t.state === "working" && !ended) S.start.classList.add("k-active");
        if (t.state === "paused" && !ended) S.pause.classList.add("k-active");
        if (t.state === "failure" && !ended)
          S.failure.classList.add("k-active");
        if (t.state === "change" && !ended) S.change.classList.add("k-active");
        if (ended) S.end.classList.add("k-active");
      }
      function computeAndTopState(it) {
        const p = computeProgress(it);
        const statusMap = {
          working: "Praca",
          paused: "Pauza",
          failure: "Awaria",
          change: "Zmiana",
          ended: "Zako≈Ñczono",
          idle: "Oczekuje",
        };
        p.stateText = statusMap[p.state] || "Oczekuje";
        $("#topState").textContent = "Proces: " + p.stateText;
        return p;
      }
      function renderCurrent() {
        const card = document.querySelector("#viewKiosk .card:first-of-type");
        if (!card) return;

        const idx = getCurrentIndex();
        const it = idx !== -1 ? demo.items[idx] : null;

        // Stan: "Brak materia≈Çu"
        if (!it) {
          card.innerHTML = `
          <div class="title">
            <span>Obecny materia≈Ç</span>
            <span class="k-topstate" id="topState">Proces: Oczekuje</span>
          </div>
          <div class="row" style="justify-content: center; padding: 20px 0;">
            <div class="muted">Brak aktywnego materia≈Çu.</div>
          </div>
        `;
          setButtonsState(null);
          return;
        }

        // Stan: JEST materia≈Ç
        const p = computeAndTopState(it);
        const percentTxt = Number.isFinite(it.percent) ? `${it.percent}%` : "‚Äî";

        card.innerHTML = `
        <div class="title">
          <span>Obecny materia≈Ç</span>
          <span class="k-topstate" id="topState">${
            "Proces: " + p.stateText
          }</span>
        </div>
        
        <div class="current-wrapper">
          <div class="current-info-block">
            <div class="row" style="justify-content: center; gap: 12px;">
              <strong style="font-size: 24px; color: var(--text);">${
                idx + 1
              }. ${it.material}</strong> 
              ${idPill(it.id)} 
              ${statusDot(p.state)}
            </div>
            <div class="muted" style="margin-top: 6px;">
              Ilo≈õƒá: ${it.amount.toLocaleString("pl-PL")} kg ‚Ä¢
              Proces: ${it.process || "‚Äî"} ‚Ä¢
              % wsadu: ${percentTxt} ‚Ä¢
              Komentarz: ${it.comment ? it.comment : "‚Äî"}
            </div>
            <div class="row" style="justify-content: center; gap: 8px; margin-top: 12px;">
              <button class="btn secondary" onclick="openDetails(${idx})">Szczeg√≥≈Çy</button>
              <button class="btn secondary" onclick="openPhotos()">PodglƒÖd zdjƒôƒá</button>
            </div>
          </div>

          <div class="k-actions">
            <button class="kbtn start" id="kBtnStart"><span style="font-size:22px">‚ñ∂Ô∏è</span>Start</button>
            <button class="kbtn pause" id="kBtnPause"><span style="font-size:22px">‚è∏Ô∏è</span>Pauza</button>
            <button class="kbtn failure" id="kBtnFailure"><span style="font-size:22px">‚õî</span>Awaria</button>
            <button class="kbtn change" id="kBtnChange"><span style="font-size:22px">üü£</span>Zmiana</button>
            <button class="kbtn end" id="kBtnEnd"><span style="font-size:22px">‚èπÔ∏è</span>Koniec</button>
          </div>

          <div id="kProgressBox">
            <div class="progress"><div style="width:${p.pct}%;"></div></div>
            <div class="progress-label">${p.pct}% (${p.processed.toFixed(
          1
        )} / ${p.total.toFixed(1)} kg)</div>
          </div>
        </div>
      `;

        // === KLUCZOWA POPRAWKA: Podpinamy event listenery PO renderowaniu HTML ===
        $("#kBtnStart").onclick = () => {
          const i = getCurrentIndex();
          if (i === -1) return;
          const it = demo.items[i];
          const t = ensureTiming(it);
          const now = Date.now();
          if (!t.start) t.start = now;
          ["pauses", "failures", "changes"].forEach((k) => {
            const a = t[k];
            if (a.length && a[a.length - 1].end == null)
              a[a.length - 1].end = now;
          });
          t.state = "working";
          render();
        };
        $("#kBtnPause").onclick = () => {
          const i = getCurrentIndex();
          if (i === -1) return;
          const it = demo.items[i];
          const t = ensureTiming(it);
          const now = Date.now();
          const close = (k) => {
            const a = t[k];
            if (a.length && a[a.length - 1].end == null)
              a[a.length - 1].end = now;
          };
          const open = (k) => {
            t[k].push({ start: now, end: null });
          };
          if (t.state === "paused") {
            close("pauses");
            t.state = "working";
          } else {
            close("failures");
            close("changes");
            open("pauses");
            t.state = "paused";
          }
          render();
        };
        $("#kBtnFailure").onclick = () => {
          const i = getCurrentIndex();
          if (i === -1) return;
          const it = demo.items[i];
          const t = ensureTiming(it);
          const now = Date.now();
          const close = (k) => {
            const a = t[k];
            if (a.length && a[a.length - 1].end == null)
              a[a.length - 1].end = now;
          };
          const open = (k) => {
            t[k].push({ start: now, end: null });
          };
          if (t.state === "failure") {
            close("failures");
            t.state = "working";
          } else {
            close("pauses");
            close("changes");
            open("failures");
            t.state = "failure";
          }
          render();
        };
        $("#kBtnChange").onclick = () => {
          const i = getCurrentIndex();
          if (i === -1) return;
          const it = demo.items[i];
          const t = ensureTiming(it);
          const now = Date.now();
          const close = (k) => {
            const a = t[k];
            if (a.length && a[a.length - 1].end == null)
              a[a.length - 1].end = now;
          };
          const open = (k) => {
            t[k].push({ start: now, end: null });
          };
          if (t.state === "change") {
            close("changes");
            t.state = "working";
          } else {
            close("pauses");
            close("failures");
            open("changes");
            t.state = "change";
          }
          render();
        };
        $("#kBtnEnd").onclick = () => {
          const i = getCurrentIndex();
          if (i === -1) return;
          const it = demo.items[i];
          const t = ensureTiming(it);
          const now = Date.now();
          ["pauses", "failures", "changes"].forEach((k) => {
            const a = t[k];
            if (a.length && a[a.length - 1].end == null)
              a[a.length - 1].end = now;
          });
          t.end = now;
          t.state = "ended";
          toast("Zako≈Ñczono pozycjƒô.");
          render();
        };

        setButtonsState(it);
      }
      function renderNext() {
        const cur = getCurrentIndex();
        const next = getNextIndex(Math.max(cur, -1));
        const box = $("#nextInfo");
        if (next === -1) {
          box.textContent = "Brak nastƒôpnego materia≈Çu w kolejce.";
          return;
        }
        const it = demo.items[next];
        const percentTxt = Number.isFinite(it.percent) ? `${it.percent}%` : "‚Äî";
        box.innerHTML = `<strong>${it.material}</strong> ${idPill(
          it.id
        )} ‚Ä¢ ${it.amount.toLocaleString("pl-PL")} kg ‚Ä¢ ${
          it.process || "‚Äî"
        } ‚Ä¢ ${percentTxt}`;
      }
      function renderList() {
        const host = $("#kioskList");
        host.innerHTML = "";
        demo.items.forEach((it, i) => {
          const p = computeProgress(it);
          host.innerHTML += `
          <div class="item-row">
            <div>
              <div class="row" style="gap:6px;">${i + 1}. ${
            it.material
          } ${idPill(it.id)} ${statusDot(p.state)}</div>
              <div class="muted" style="margin-top:4px;">
                ${it.amount.toLocaleString("pl-PL")} kg ‚Ä¢ ${
            it.process || "‚Äî"
          } ‚Ä¢ ${Number.isFinite(it.percent) ? it.percent + "%" : "‚Äî"} ‚Ä¢ ${
            it.comment || "‚Äî"
          }
              </div>
            </div>
            <div style="min-width:200px;">
              <div class="progress"><div style="width:${p.pct}%"></div></div>
              <div class="progress-label">${p.pct}%</div>
            </div>
          </div>`;
        });
      }
      function renderDone() {
        const host = $("#kioskDoneList");
        const items = demo.items.filter((it) => it.timing?.end != null);
        if (!items.length) {
          host.textContent = "Brak zako≈Ñczonych.";
          return;
        }
        host.innerHTML = items
          .map((it) => {
            const endTs = it.timing?.end
              ? new Date(it.timing.end).toLocaleString("pl-PL")
              : "-";
            return `<div class="item-row" style="grid-template-columns:1fr auto;">
          <div><strong>${it.material}</strong> ${idPill(it.id)}</div>
          <div class="muted">Zako≈Ñczono: ${endTs}</div>
        </div>`;
          })
          .join("");
      }

      // AKCJE KIOSKU
      $("#kBtnStart").onclick = () => {
        const i = getCurrentIndex();
        if (i === -1) return;
        const it = demo.items[i];
        const t = ensureTiming(it);
        const now = Date.now();
        if (!t.start) t.start = now;
        ["pauses", "failures", "changes"].forEach((k) => {
          const a = t[k];
          if (a.length && a[a.length - 1].end == null)
            a[a.length - 1].end = now;
        });
        t.state = "working";
        render();
      };
      $("#kBtnPause").onclick = () => {
        const i = getCurrentIndex();
        if (i === -1) return;
        const it = demo.items[i];
        const t = ensureTiming(it);
        const now = Date.now();
        const close = (k) => {
          const a = t[k];
          if (a.length && a[a.length - 1].end == null)
            a[a.length - 1].end = now;
        };
        const open = (k) => {
          t[k].push({ start: now, end: null });
        };
        if (t.state === "paused") {
          close("pauses");
          t.state = "working";
        } else {
          close("failures");
          close("changes");
          open("pauses");
          t.state = "paused";
        }
        render();
      };
      $("#kBtnFailure").onclick = () => {
        const i = getCurrentIndex();
        if (i === -1) return;
        const it = demo.items[i];
        const t = ensureTiming(it);
        const now = Date.now();
        const close = (k) => {
          const a = t[k];
          if (a.length && a[a.length - 1].end == null)
            a[a.length - 1].end = now;
        };
        const open = (k) => {
          t[k].push({ start: now, end: null });
        };
        if (t.state === "failure") {
          close("failures");
          t.state = "working";
        } else {
          close("pauses");
          close("changes");
          open("failures");
          t.state = "failure";
        }
        render();
      };
      $("#kBtnChange").onclick = () => {
        const i = getCurrentIndex();
        if (i === -1) return;
        const it = demo.items[i];
        const t = ensureTiming(it);
        const now = Date.now();
        const close = (k) => {
          const a = t[k];
          if (a.length && a[a.length - 1].end == null)
            a[a.length - 1].end = now;
        };
        const open = (k) => {
          t[k].push({ start: now, end: null });
        };
        if (t.state === "change") {
          close("changes");
          t.state = "working";
        } else {
          close("pauses");
          close("failures");
          open("changes");
          t.state = "change";
        }
        render();
      };
      $("#kBtnEnd").onclick = () => {
        const i = getCurrentIndex();
        if (i === -1) return;
        const it = demo.items[i];
        const t = ensureTiming(it);
        const now = Date.now();
        ["pauses", "failures", "changes"].forEach((k) => {
          const a = t[k];
          if (a.length && a[a.length - 1].end == null)
            a[a.length - 1].end = now;
        });
        t.end = now;
        t.state = "ended";
        toast("Zako≈Ñczono pozycjƒô.");
        render();
      };
      $("#btnStartNext").onclick = () => {
        const cur = getCurrentIndex();
        const next = getNextIndex(Math.max(cur, -1));
        if (next === -1) {
          toast("Brak kolejnej pozycji.");
          return;
        }
        if (cur !== -1) {
          const it = demo.items[cur],
            t = ensureTiming(it),
            now = Date.now();
          ["pauses", "failures", "changes"].forEach((k) => {
            const a = t[k];
            if (a.length && a[a.length - 1].end == null)
              a[a.length - 1].end = now;
          });
          t.end = now;
          t.state = "ended";
        }
        const nx = demo.items[next];
        const tt = ensureTiming(nx);
        tt.start = Date.now();
        tt.state = "working";
        toast("Rozpoczƒôto kolejnego klienta.");
        render();
      };

      // SOS
      $("#btnSOS").onclick = () => {
        $("#sosModal").style.display = "flex";
      };
      function closeSOS() {
        $("#sosModal").style.display = "none";
      }
      function sendHelp() {
        toast("Wys≈Çano pro≈õbƒô o pomoc ‚úÖ");
        closeSOS();
      }
      function openFailureQR() {
        closeSOS();
        openQR("failure");
      }

      // QR
      $("#btnLoginQR").onclick = () => openQR("login");
      $("#btnScan").onclick = () => emulateScan();
      $("#camArea").onclick = () => emulateScan();
      function openQR(mode) {
        qrMode = mode || "login";
        $("#qrTitle").textContent =
          qrMode === "failure"
            ? "Zg≈Ço≈õ awariƒô ‚Äî zeskanuj QR"
            : "Zaloguj przez QR";
        $("#qrModal").style.display = "flex";
      }
      function closeQR() {
        $("#qrModal").style.display = "none";
      }
      function emulateScan() {
        if (qrMode === "login") {
          loggedIn = true;
          closeQR();
          toast("Zalogowano przez QR ‚úÖ");
          showPrev();
        } else {
          closeQR();
          toast("Awaria zg≈Çoszona: AWARIA-12345 ‚úÖ");
        }
      }

      // LOGOWANIE/RESET
      $("#btnSkip").onclick = () => {
        loggedIn = true;
        toast("Tryb demo bez logowania");
        showPrev();
      };
      $("#btnLogout").onclick = () => {
        loggedIn = false;
        toast("Wylogowano");
        showLogin();
      };
      $("#btnReset").onclick = () => {
        demo.items.forEach((it) => (it.timing = {}));
        demo.done = [];
        toast("Zresetowano demo.");
        render();
      };

      // Prewencja ‚Äì potwierdzenie
      $("#btnPrevConfirm").onclick = () => {
        toast("Prewencja potwierdzona ‚úÖ");
        setTimeout(() => showKiosk(), 400);
      };

      // Auto od≈õwie≈ºanie
      setInterval(() => {
        if (loggedIn && $("#viewKiosk").style.display === "block") render();
      }, 1000);

      // Start
      showLogin();

      // Szczeg√≥≈Çy / Zdjƒôcia
      function openDetails(idx) {
        const it = demo.items[idx];
        const t = ensureTiming(it);
        const p = computeProgress(it);
        const fmt = (ms) => {
          const sec = Math.floor(ms / 1000),
            h = Math.floor(sec / 3600),
            m = Math.floor((sec % 3600) / 60),
            s = sec % 60;
          const pad = (n) => String(n).padStart(2, "0");
          return `${pad(h)}:${pad(m)}:${pad(s)}`;
        };
        let work = 0,
          total = 0;
        if (t.start) {
          const end = t.end || Date.now();
          total = end - t.start;
          work =
            total -
            sumIntervals(t.pauses) -
            sumIntervals(t.failures) -
            sumIntervals(t.changes);
          if (work < 0) work = 0;
        }
        $("#detailsContent").innerHTML = `
        <div><strong>Materia≈Ç:</strong> ${it.material} ${idPill(it.id)}</div>
        <div><strong>Ilo≈õƒá:</strong> ${it.amount.toLocaleString(
          "pl-PL"
        )} kg</div>
        <div><strong>Proces:</strong> ${
          it.process || "‚Äî"
        } ‚Ä¢ <strong>% wsadu:</strong> ${
          Number.isFinite(it.percent) ? it.percent + "%" : "‚Äî"
        }</div>
        <div style="margin-top:8px;"><strong>Start:</strong> ${
          t.start ? new Date(t.start).toLocaleString("pl-PL") : "‚Äî"
        } ‚Ä¢ <strong>Koniec:</strong> ${
          t.end ? new Date(t.end).toLocaleString("pl-PL") : "‚Äî"
        }</div>
        <div><strong>Postƒôp:</strong> ${p.pct}% (${p.processed.toFixed(
          1
        )} / ${p.total.toFixed(1)} kg)</div>
      `;
        $("#detailsModal").style.display = "flex";
      }
      function closeDetails() {
        $("#detailsModal").style.display = "none";
      }
      function openPhotos() {
        $("#photosModal").style.display = "flex";
      }
      function closePhotos() {
        $("#photosModal").style.display = "none";
      }
    </script>
  </body>
</html>
